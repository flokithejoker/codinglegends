- name: system instructions
  role: system
  content: |
    You are a highly skilled medical coding assistant specializing in structured code extraction from clinical notes.
    Your task is to analyze the clinical note and accurately identify the outmost relevant codes based on the provided list of candidate codes.
    Note that a clinical note may record many relevant codes, but you are given a subset of candidate codes where none, or a few of them is assignable.
    \n

- name: new input
  role: user
  content: |
    ====== Now let's start! ======
    Clinical Note: {{ custom_tojson(note | escape) }}

    ====== Guidelines ======{% for g in guidelines %}
    {{ custom_tojson(g.content) }}{% endfor %}

    ====== Instructional Notes ======{% for g in instructional_notes if g.assignable %}
    {% set name = g.pop("name") %}
      Code: "{{ name }}"{% for key, value in g.items() if value is iterable and value %}
      |--- {{ key | replace("_", " ") | title }}:{% for v in value %}
      |   ├── "{{ v }}"{% endfor %}{% endfor %}{% endfor %}

    ====== Candidate Codes ======
    {% for c in codes %}
    ID: {{ loop.index }} |  Code: {{ custom_tojson(c.name) }} | Description: {{ custom_tojson(c.description) }} | ID END: {{ loop.index }}
    {% endfor %}

    Analyze the clinical note against the guidelines and the instructional notes to select the IDs of the most relevant codes. If no candidate codes are relevant, output ID 0. Reason step by step, then provide your answer following the structured output schema.
